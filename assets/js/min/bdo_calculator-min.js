/*
* @Author: SirMrE
* @http: http://www.sirmre.com/bdo-calculator
* @Copyright: (c) 2016 Mark Eliasen
* @license: May be freely distributed under the CC BY-NC 3.0 License 
*           (https://creativecommons.org/licenses/by-nc/3.0/)
* @Date:   2016-04-08 23:52:45
* @Last Modified by:   SirMrE
* @Last Modified time: 2016-04-15 02:01:42
*/
var BDOcalculator={gear:{},sets:{},stats:null,init:function(){this.gear={"main-weapon":{enhancement:0,item_name:"",item:{},gems:{1:{gem_name:"",gem:{}},2:{gem_name:"",gem:{}}}},"secondary-weapon":{enhancement:0,item_name:"",item:{},gems:{1:{gem_name:"",gem:{}},2:{gem_name:"",gem:{}}}},helmet:{enhancement:0,item_name:"",item:{},gems:{1:{gem_name:"",gem:{}},2:{gem_name:"",gem:{}}}},armor:{enhancement:0,item_name:"",item:{},gems:{1:{gem_name:"",gem:{}},2:{gem_name:"",gem:{}}}},gloves:{enhancement:0,item_name:"",item:{},gems:{1:{gem_name:"",gem:{}},2:{gem_name:"",gem:{}}}},shoes:{enhancement:0,item_name:"",item:{},gems:{1:{gem_name:"",gem:{}},2:{gem_name:"",gem:{}}}},rings:{1:{enhancement:0,item_name:"",item:{}},2:{enhancement:0,item_name:"",item:{}}},earrings:{1:{enhancement:0,item_name:"",item:{}},2:{enhancement:0,item_name:"",item:{}}},necklace:{enhancement:0,item_name:"",item:{}},belt:{enhancement:0,item_name:"",item:{}}},this.reset()},setGear:function(e,t,a,n,i,s){s="function"==typeof s?s:function(){},"undefined"==typeof e&&(e={}),$.inArray(t,["ring","earring"])!==-1?(this.gear[t+"s"][a].item=e,this.gear[t+"s"][a].item_name=n):"gems"===i?(this.gear[t].gems[a].gem=e,this.gear[t].gems[a].gem_name=n):"undefined"!=typeof this.gear[t].item&&(this.gear[t].item=e,this.gear[t].item_name=n,this.gear[t].gems={1:{gem_name:"",gem:{}},2:{gem_name:"",gem:{}}}),s()},setEnchantmentLevel:function(e,t,a,n){n="function"==typeof n?n:function(){},$.inArray(e,["ring","earring"])!==-1?this.gear[e+"s"][t].enhancement=String(a):this.gear[e].enhancement=String(a),n()},reset:function(){this.stats=$.extend(!0,{},BDOdatabase.stats),this.sets={}},addStat:function(e,t){if(e in this.stats){if("special"===e)return void this.stats.special.specials.push(t);if("undefined"==typeof this.stats[e].total&&"undefined"==typeof this.stats[e].min)return void(this.stats[e].active=!0);"ap"===e?(t=parseInt(t)===t?[t,t]:t.split("-"),this.stats[e].min+=parseInt(t[0]),this.stats[e].max+=parseInt(t[1])):this.stats[e].total+=t}},calculateSetEffects:function(){if(0!==Object.keys(this.sets).length)for(var e in this.sets)if(this.sets.hasOwnProperty(e)&&"undefined"!=typeof BDOdatabase.set_effects[e]){var t=BDOdatabase.set_effects[e],a=this.sets[e].length;for(var n in t.pieces)if(t.pieces.hasOwnProperty(n)){var i=t.pieces[n];if(n=parseInt(n),n<=a)for(var s in i)i.hasOwnProperty(s)&&this.addStat(s,i[s])}for(var m in t.combos)if(t.combos.hasOwnProperty(m)){for(var i=t.combos[m].effects,r=!0,h=t.combos[m].pieces,g=h.length-1;g>=0;g--)if($.inArray(h[g],this.sets[e])===-1){r=!1;break}if(r)for(var s in i)i.hasOwnProperty(s)&&this.addStat(s,i[s])}}},addToSets:function(e,t){"undefined"==typeof this.sets[e]&&(this.sets[e]=[]),this.sets[e].push(t)},getItemStat:function(e,t,a,n){var a="undefined"!=typeof a&&a,i=a?e.item_effects[t]:e[t];return"undefined"!==String(e.enhancement)&&"0"!==String(n)&&"undefined"!=typeof e.enhancement[String(n)][t]&&(i=e.enhancement[String(n)][t]),i},getGearStat:function(e,t,a){var a="undefined"!=typeof a,n=a?e.item.item_effects[t]:e.item[t];return"undefined"!==String(e.enhancement)&&"0"!==e.enhancement&&"undefined"!=typeof e.item.enhancement[String(e.enhancement)][t]&&(n=e.item.enhancement[String(e.enhancement)][t]),n},calculate:function(){$(".stats").html(""),this.reset();for(var e in this.gear)if(this.gear.hasOwnProperty(e))if($.inArray(e,["rings","earrings"])!==-1){for(var t in this.gear[e])if(this.gear[e].hasOwnProperty(t)){var a=this.gear[e][t];if(0!==Object.keys(a.item).length){for(var n in a.item)a.item.hasOwnProperty(n)&&this.addStat(n,this.getGearStat(a,n));for(var i in a.item.item_effects)a.item.item_effects.hasOwnProperty(i)&&this.addStat(i,this.getGearStat(a,i,!0))}}}else if(Object.keys(this.gear[e].item).length>0){for(var s in this.gear[e].item)if(this.gear[e].item.hasOwnProperty(s)){var m=this.gear[e].item;this.addStat(s,this.getGearStat(this.gear[e],s))}for(var i in this.gear[e].item.item_effects)this.gear[e].item.item_effects.hasOwnProperty(i)&&this.addStat(i,this.getGearStat(this.gear[e],i,!0));for(var r in this.gear[e].gems)if(this.gear[e].gems.hasOwnProperty(r)){var h=this.gear[e].gems[r].gem;for(var g in h.item_effects)h.item_effects.hasOwnProperty(g)&&(h.incompatible.length&&$.inArray(this.gear[e].gems["1"===r?"2":"1"].gem_name,h.incompatible)!==-1||this.addStat(g,h.item_effects[g]))}switch(this.addToSets(this.gear[e].item.set,e),e){case"main-weapon":case"secondary-weapon":this.addStat("ap",this.getGearStat(this.gear[e],"ap_min")+"-"+this.getGearStat(this.gear[e],"ap_max"))}}this.calculateSetEffects();for(var f in this.stats)if(this.stats.hasOwnProperty(f)){var c=this.stats[f];switch(f){case"special":for(var o=c.specials.length-1;o>=0;o--)$(c.target).append("<li>"+c.specials[o]+"</li>");break;case"ap":$(".stat-ap span").text(c.min+" ~ "+c.max);break;case"dp":$(".stat-dp span").text(c.total);break;default:if("undefined"==typeof c.total){c.active&&this.stats.special.specials.push(c.title);continue}if(0===c.total)continue;$(c.target).append("<li><strong>"+c.title+":</strong> "+c.total+c.symbol+"</li>")}}}};